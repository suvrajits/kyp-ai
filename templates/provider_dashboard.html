<!-- templates/provider_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProviderGPT Dashboard</title>
  <style>
    /* üåô DARK THEME ROOT */
    body {
      margin: 0;
      background: #0e0f12;
      color: #f5f5f5;
      font-family: "Inter", sans-serif;
      overflow: hidden;
    }

    /* üîπ Sidebar (left vertical menu) */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 70px;
      height: 100%;
      background: #16181c;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      gap: 25px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.3);
      z-index: 20;
    }
    .sidebar-icon {
      font-size: 22px;
      cursor: pointer;
      color: #aaa;
      transition: 0.25s;
    }
    .sidebar-icon:hover { color: #00aaff; transform: scale(1.1); }

    /* üîπ Main chat container */
    .main {
      margin-left: 90px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: flex-end;
      align-items: center;
    }

    /* Chat area (scrollable) */
    .chat-window {
      flex: 1;
      width: 60%;
      max-width: 850px;
      overflow-y: auto;
      padding: 30px;
      box-sizing: border-box;
      scrollbar-width: thin;
    }

    /* Message bubbles */
    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 10px;
      line-height: 1.5;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 15px;
    }
    .user-msg {
      background: #0077cc;
      color: white;
      align-self: flex-end;
    }
    .ai-msg {
      background: #1b1d21;
      border: 1px solid #333;
      color: #f0f0f0;
      align-self: flex-start;
    }

    /* Chat input bar (fixed bottom) */
    .chat-bar {
      position: fixed;
      bottom: 0;
      left: 90px;
      right: 0;
      background: #16181c;
      padding: 15px 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.4);
      z-index: 10;
    }
    .chat-input-container {
      display: flex;
      align-items: center;
      background: #1e2024;
      border-radius: 12px;
      padding: 10px 15px;
      width: 60%;
      max-width: 850px;
    }
    .chat-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #f5f5f5;
      font-size: 15px;
      outline: none;
    }
    .upload-btn, .send-btn {
      background: #00aaff;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 8px 14px;
      margin-left: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .upload-btn:hover, .send-btn:hover {
      background: #0090dd;
      transform: translateY(-1px);
    }

    /* Hidden file input */
    #file-input {
      display: none;
    }

    /* üîπ Slide Panels */
    .side-panel {
      position: fixed;
      top: 0;
      left: -400px;
      width: 380px;
      height: 100%;
      background: #1b1d21;
      color: #eee;
      overflow-y: auto;
      padding: 20px;
      transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.4);
      z-index: 15;
    }
    .side-panel.active { left: 70px; }
    canvas { margin-top: 20px; }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-icon" onclick="togglePanel('risk')">üìä</div>
    <div class="sidebar-icon" onclick="togglePanel('details')">üè•</div>
    <div class="sidebar-icon" onclick="togglePanel('upload')">üìÅ</div>
    <div class="sidebar-icon" onclick="togglePanel('actions')">‚öôÔ∏è</div>
  </div>

  <!-- Chat Section -->
  <div class="main">
    <div id="chat-window" class="chat-window"></div>

    <!-- Fixed Chat Bar -->
    <div class="chat-bar">
      <div class="chat-input-container">
        <input id="query" class="chat-input" placeholder="Ask about provider compliance, license, or risk..." />
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">üìé</button>
        <input type="file" id="file-input" multiple />
        <button id="send-btn" class="send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div id="risk-panel" class="side-panel">
    <h3>üìä Provider Risk Breakdown</h3>
    <canvas id="riskChart"></canvas>
  </div>

  <div id="details-panel" class="side-panel">
    <h3>üè• Provider Details</h3>
    {% for key, value in provider.items() %}
      <div style="margin-bottom:10px;"><strong>{{ key.replace('_',' ')|title }}</strong>: {{ value }}</div>
    {% endfor %}
  </div>

  <div id="upload-panel" class="side-panel">
    <h3>üìÅ Upload Documents</h3>
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" name="files" multiple required />
      <button type="submit" class="send-btn">Upload</button>
    </form>
  </div>

  <div id="actions-panel" class="side-panel">
    <h3>‚öôÔ∏è Actions</h3>
    <form action="/dashboard/approve/{{ app_id }}" method="post"><button class="send-btn">‚úÖ Approve</button></form>
    <form action="/dashboard/reject/{{ app_id }}" method="post"><button class="send-btn">‚ùå Reject</button></form>
    <form action="/dashboard/request-info/{{ app_id }}" method="post"><button class="send-btn">üì® Request Info</button></form>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const chatWindow = document.getElementById("chat-window");
    const queryInput = document.getElementById("query");

    function togglePanel(name) {
      ["risk","details","upload","actions"].forEach(id => {
        const el = document.getElementById(`${id}-panel`);
        el.classList.remove("active");
      });
      const target = document.getElementById(`${name}-panel`);
      if (target) target.classList.toggle("active");

      if (name === "risk") loadRiskChart();
    }

    async function sendMessage() {
      const query = queryInput.value.trim();
      if (!query) return;
      const userMsg = document.createElement("div");
      userMsg.className = "message user-msg";
      userMsg.textContent = query;
      chatWindow.appendChild(userMsg);
      queryInput.value = "";

      const aiMsg = document.createElement("div");
      aiMsg.className = "message ai-msg";
      aiMsg.textContent = "Thinking...";
      chatWindow.appendChild(aiMsg);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const response = await fetch("/rag/ask", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ query, provider_id: "{{ app_id }}", top_k: 3 }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          fullText += decoder.decode(value);
          aiMsg.innerHTML = fullText.replace(/\n/g, "<br>");
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      } catch (e) {
        aiMsg.textContent = "‚ùå Error fetching response.";
      }
    }

    document.getElementById("send-btn").addEventListener("click", sendMessage);
    queryInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    async function loadRiskChart() {
      const ctx = document.getElementById("riskChart");
      const res = await fetch(`/risk/calc/{{ app_id }}`);
      const data = await res.json();
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data.categories),
          datasets: [{
            label: 'Risk %',
            data: Object.values(data.categories),
            backgroundColor: '#00aaff'
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    // Handle document upload + embedding
    document.getElementById("file-input").addEventListener("change", async (e) => {
      const files = e.target.files;
      if (!files.length) return;
      const formData = new FormData();
      for (const file of files) formData.append("files", file);
      const res = await fetch(`/rag/{{ app_id }}/ingest`, { method: "POST", body: formData });
      if (res.ok) alert("‚úÖ Document uploaded and embedded successfully!");
      else alert("‚ùå Upload failed");
    });
  </script>
</body>
</html>
