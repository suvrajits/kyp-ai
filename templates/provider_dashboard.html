<!-- templates/provider_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProviderGPT Dashboard</title>
  <style>
    body {
      margin: 0;
      background: #f9fafc;
      color: #222;
      font-family: "Inter", sans-serif;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 80px;
      height: 100%;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      gap: 20px;
      box-shadow: 2px 0 6px rgba(0,0,0,0.05);
      z-index: 20;
    }
    .sidebar-item {
      position: relative;
      text-align: center;
      color: #555;
      cursor: pointer;
      transition: 0.25s;
      font-size: 20px;
    }
    .sidebar-item:hover { color: #0077cc; transform: scale(1.1); }
    .sidebar-label {
      font-size: 11px;
      margin-top: 4px;
      color: #888;
    }
    .badge {
      position: absolute;
      top: -6px;
      right: 10px;
      background: #0077cc;
      color: white;
      font-size: 10px;
      font-weight: bold;
      border-radius: 10px;
      padding: 2px 6px;
      display: none;
    }

    /* Header */
    .header {
      position: fixed;
      top: 15px;
      right: 30px;
      text-align: right;
      z-index: 25;
    }
    .header h2 { margin: 0; font-size: 22px; color: #222; }
    .header p { margin: 2px 0 0; font-size: 14px; color: #666; }

    /* Main chat */
    .main {
      margin-left: 100px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      justify-content: flex-end;
      align-items: center;
    }

    /* Chat window */
    .chat-window {
      flex: 1;
      width: 65%;
      max-width: 900px;
      overflow-y: auto;
      padding: 40px;
      box-sizing: border-box;
    }

    /* Messages */
    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 10px;
      line-height: 1.5;
      max-width: 80%;
      font-size: 15px;
    }
    .user-msg { background: #0077cc; color: #fff; align-self: flex-end; }
    .ai-msg { background: #f1f3f5; color: #222; align-self: flex-start; }

    /* Chat input bar */
    .chat-bar {
      position: fixed;
      bottom: 0;
      left: 100px;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .chat-input-container {
      display: flex;
      align-items: center;
      background: #f4f6f8;
      border-radius: 12px;
      padding: 10px 15px;
      width: 65%;
      max-width: 900px;
      border: 1px solid #ddd;
    }
    .chat-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #222;
      font-size: 15px;
      outline: none;
    }
    .upload-btn, .send-btn {
      background: #0077cc;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 8px 14px;
      margin-left: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .upload-btn:hover, .send-btn:hover {
      background: #005fa3;
      transform: translateY(-1px);
    }
    #file-input { display: none; }

    /* Slide panels */
    .side-panel {
      position: fixed;
      top: 0;
      left: -400px;
      width: 380px;
      height: 100%;
      background: #fff;
      color: #222;
      overflow-y: auto;
      padding: 20px;
      border-right: 1px solid #e0e0e0;
      transition: left 0.3s ease;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 15;
    }
    .side-panel.active { left: 80px; }

    .close-panel {
      text-align: right;
      font-size: 18px;
      cursor: pointer;
      color: #0077cc;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .doc-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }
    .doc-list li {
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .doc-list li span {
      font-size: 14px;
      color: #444;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-item" onclick="togglePanel('risk')">
      üìä
      <div class="sidebar-label">Risk</div>
    </div>
    <div class="sidebar-item" onclick="togglePanel('details')">
      üè•
      <div class="sidebar-label">Details</div>
    </div>
    <div class="sidebar-item" onclick="togglePanel('upload')">
      üìÅ
      <div class="badge" id="upload-badge">0</div>
      <div class="sidebar-label">Upload</div>
    </div>
    <div class="sidebar-item" onclick="togglePanel('actions')">
      ‚öôÔ∏è
      <div class="sidebar-label">Actions</div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <h2>Provider Dashboard</h2>
    <p>{{ provider.provider_name }} ‚Äî {{ provider.license_number }}</p>
  </div>

  <!-- Chat Section -->
  <div class="main">
    <div id="chat-window" class="chat-window"></div>
    <div class="chat-bar">
      <div class="chat-input-container">
        <input id="query" class="chat-input" placeholder="Ask about provider compliance, license, or risk..." />
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">üìé</button>
        <input type="file" id="file-input" multiple />
        <button id="send-btn" class="send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- Panels -->
  <div id="risk-panel" class="side-panel">
    <div class="close-panel" onclick="togglePanel('risk')">‚¨Ö Close</div>
    <h3>üìä Provider Risk Breakdown</h3>
    <canvas id="riskChart"></canvas>
  </div>

  <div id="details-panel" class="side-panel">
    <div class="close-panel" onclick="togglePanel('details')">‚¨Ö Close</div>
    <h3>üè• Provider Details</h3>
    {% for key, value in provider.items() %}
      <div style="margin-bottom:10px;"><strong>{{ key.replace('_',' ')|title }}</strong>: {{ value }}</div>
    {% endfor %}
  </div>

  <div id="upload-panel" class="side-panel">
    <div class="close-panel" onclick="togglePanel('upload')">‚¨Ö Close</div>
    <h3>üìÅ Upload Documents</h3>
    <form id="upload-form" enctype="multipart/form-data">
      <input type="file" name="files" multiple required />
      <button type="submit" class="send-btn">Upload</button>
    </form>

    <h4 style="margin-top:15px;">üìÑ Uploaded Files</h4>
    <ul id="doc-list" class="doc-list">
      <li><span>Loading documents...</span></li>
    </ul>
  </div>

  <div id="actions-panel" class="side-panel">
    <div class="close-panel" onclick="togglePanel('actions')">‚¨Ö Close</div>
    <h3>‚öôÔ∏è Actions</h3>
    <form action="/dashboard/approve/{{ app_id }}" method="post"><button class="send-btn">‚úÖ Approve</button></form>
    <form action="/dashboard/reject/{{ app_id }}" method="post"><button class="send-btn">‚ùå Reject</button></form>
    <form action="/dashboard/request-info/{{ app_id }}" method="post"><button class="send-btn">üì® Request Info</button></form>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const chatWindow = document.getElementById("chat-window");
    const queryInput = document.getElementById("query");
    const badge = document.getElementById("upload-badge");
    const docList = document.getElementById("doc-list");

    function togglePanel(name) {
      ["risk","details","upload","actions"].forEach(id => {
        const el = document.getElementById(`${id}-panel`);
        if (name === id && !el.classList.contains("active")) el.classList.add("active");
        else el.classList.remove("active");
      });
      if (name === "risk") loadRiskChart();
      if (name === "upload") refreshDocumentList();
    }

    async function refreshDocumentList() {
      const res = await fetch(`/dashboard/docs/{{ app_id }}`);
      if (!res.ok) return;
      const docs = await res.json();
      docList.innerHTML = "";

      if (!docs.length) {
        docList.innerHTML = "<li><span>No documents uploaded yet.</span></li>";
        badge.style.display = "none";
        return;
      }

      docs.forEach(d => {
        const li = document.createElement("li");
        const icon = d.type === "license" ? "üìú" : "üìÑ";
        li.innerHTML = `<span>${icon} ${d.filename}</span>`;
        docList.appendChild(li);
      });

      badge.textContent = docs.length;
      badge.style.display = "block";
    }

    async function sendMessage() {
      const query = queryInput.value.trim();
      if (!query) return;
      const userMsg = document.createElement("div");
      userMsg.className = "message user-msg";
      userMsg.textContent = query;
      chatWindow.appendChild(userMsg);
      queryInput.value = "";

      const aiMsg = document.createElement("div");
      aiMsg.className = "message ai-msg";
      aiMsg.textContent = "Thinking...";
      chatWindow.appendChild(aiMsg);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const response = await fetch("/rag/ask", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ query, provider_id: "{{ app_id }}", top_k: 3 }),
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          fullText += decoder.decode(value);
          aiMsg.innerHTML = fullText.replace(/\n/g, "<br>");
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      } catch (e) {
        aiMsg.textContent = "‚ùå Error fetching response.";
      }
    }

    document.getElementById("send-btn").addEventListener("click", sendMessage);
    queryInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

    async function loadRiskChart() {
      const ctx = document.getElementById("riskChart");
      const res = await fetch(`/risk/calc/{{ app_id }}`);
      const data = await res.json();
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(data.categories),
          datasets: [{
            label: 'Risk %',
            data: Object.values(data.categories),
            backgroundColor: '#0077cc'
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    // Upload handler
    document.getElementById("file-input").addEventListener("change", async (e) => {
      const files = e.target.files;
      if (!files.length) return;
      const formData = new FormData();
      for (const file of files) formData.append("files", file);

      const res = await fetch(`/rag/{{ app_id }}/ingest`, { method: "POST", body: formData });
      const data = await res.json();
      if (res.ok && data.status === "success") {
        alert("‚úÖ Document uploaded and embedded successfully!");
        refreshDocumentList();
      } else {
        alert("‚ùå Upload failed");
      }
    });
  </script>
</body>
</html>
